# CHANGELOG - 安家診所掛號助手

所有重要的變更都會記錄在此文件。

---

## [v4.3.2] - 2025-11-23

### 🎯 應用程式更名與日期格式優化

**更名**
- 應用程式名稱從「安佳診所櫃檯助手」改為「安家診所掛號助手」
- 更新所有相關文件（README.md, CLAUDE.md, package.json, index.html）

**日期格式優化**
- 統一所有日期顯示為民國年格式（例如：112/09/28）
- 生日欄位額外顯示西元年參考（例如：76/10/15 (1987/10/15)）
- 更新以下元件的日期格式：
  - PreventiveCare.jsx（預防保健）
  - VisitHistory.jsx（就診歷史）
  - AppointmentRecords.jsx（預約紀錄）
  - ChronicDiseaseManagement.jsx（慢性病管理）
  - ExaminationHistory.jsx（檢查記錄）

**檔案變更**
- `package.json`: 版本更新為 4.3.2，productName 更新
- `index.html`: title 更新
- `README.md`: 標題與版本更新
- `CLAUDE.md`: 標題與版本歷史更新
- `CHANGELOG.md`: 新增此版本記錄
- `src/db/dbf-reader.js`: formatBirthDate() 函數更新
- 5 個前端元件的 formatDate() 函數更新

---

## [v4.3.1] - 2025-11-22

### 🎯 重大功能：動態記憶體管理

**新增**
- 可調整的預載入資料範圍（config.ini: `preload_years_back`）
- 支援只載入最近 N 年的資料，減少記憶體占用
- 預設載入最近 3 年資料（記憶體占用約 200MB）

**效益**
- 永久解決未來資料增長問題
- 記憶體可從 500MB 降到 150-200MB
- 查詢速度不受影響（< 100ms）

**設定方式**
```ini
[performance]
preload_years_back = 2  # 推薦：最近 2 年（記憶體約 150MB）
```

---

## [v4.3] - 2025-11-22

### ⚡ 重大效能優化：全量預載入機制

**問題發現**
- DBF 檔案讀取極其緩慢（10秒+）
- CO05O (90,619筆): 讀取 8.6 秒
- CO02M (275,861筆): 讀取 8.0 秒
- 即使關閉防毒軟體也無改善

**解決方案**
- 啟動時預載入所有 DBF 表格到記憶體（約 500MB）
- 所有查詢直接從記憶體過濾（不再讀取磁碟）
- 支援網路磁碟環境

**效益**
- 啟動時間：增加 20-30 秒（一次性）
- 查詢時間：**從 10 秒降到 < 0.1 秒**（100倍提升！）
- 網路磁碟：完全支援，查詢速度不受影響

**修改檔案**
- `src/db/dbf-reader.js`: 新增 preloadAllTables() 和 readDBFFromDisk()
- `src/db/database-manager.js`: 初始化時呼叫預載入

---

## [v4.2] - 2025-11-22

### 🚀 效能優化（初版，後被 v4.3 取代）

**優化項目**
1. 合併 CO05O 重複查詢（省下 300-400ms）
2. 並行查詢（Promise.all）（省下 200-400ms）
3. LRU 快取機制（小檔案）（省下 100-150ms）
4. 快取日期計算（省下 <5ms）

**效果**
- 原始目標：1.2-1.8 秒 → 0.5-0.8 秒
- 實際測量：仍有 5-10 秒延遲（DBF 讀取瓶頸）

---

## [v4.1] - 2025-11-22

### 🩺 預防保健功能修正

**重要修正**
- ✅ 修正成健卡序定義錯誤
  - 成健一階：3D（30-39歲）、21（40-64歲）、**22**（65歲以上）
  - 成健二階：3E（30-39歲）、**23**（40-64歲）、24（65歲以上）

**新增**
- ✅ 完診時間（TENDTIME）檢查邏輯，過濾掛號錯誤記錄
- ✅ 流感/新冠疫苗改用「施打季」邏輯（10月-6月為同一季）

**優化**
- 清理暫存測試檔案
- 更新文件說明

**修改檔案**
- `src/db/dbf-reader.js`: 卡序定義、TENDTIME 檢查
- `src/renderer/components/PreventiveCare.jsx`: 疫苗施打季邏輯

---

## [v4.0] - 2025-11-22

### 🆕 新增預防保健功能

**新功能**
- ✅ 預防保健判斷（成健、篩檢、疫苗）
  - 成人健檢一階、二階
  - 腸篩（大腸癌篩檢）
  - 口篩（口腔癌篩檢）
  - 流感疫苗
  - 新冠疫苗
  - 肺鏈疫苗
- ✅ 預約紀錄顯示
- ✅ 就診歷史顯示

**UI 優化**
- ✅ 移除檢驗矩陣和診療歷程（簡化 UI）
- ✅ 優化基本資料顯示（備註完整顯示、左右分欄）

**修改檔案**
- 新增 `src/renderer/components/PreventiveCare.jsx`
- 新增 `src/renderer/components/AppointmentRecords.jsx`
- 新增 `src/renderer/components/VisitHistory.jsx`
- 修改 `src/db/dbf-reader.js`: 新增相關查詢方法

---

## [v3.0] - 2025-11-22

### 🔄 資料庫架構重構

**重大變更**
- ✅ 檢驗結果 SQLite 快取
- ✅ 民國年曆支援（7 位數 YYYMMDD 格式）
- ✅ 欄位名稱正規化（大寫轉小寫）
- ✅ 全域熱鍵支援
- ✅ 病患查詢錯誤修復

**資料流優化**
- CO18H → SQLite 轉置為寬表
- 查詢時間從 13-15 秒降至不到 1 秒

**修改檔案**
- `src/db/database-manager.js`: 新增 normalizeFieldNames()
- `src/db/dbf-reader.js`: 民國年計算、年齡計算
- `src/shared/utils.js`: 病歷號格式化（7 位數）

---

## 歷史修復記錄

### 1. 欄位名稱大小寫不一致（2025-11-22）
- **問題**: DBF 回傳大寫欄位，前端期望小寫
- **修復**: 新增 normalizeFieldNames() 方法
- **檔案**: `src/db/database-manager.js`

### 2. 病歷號格式（2025-11-22）
- **問題**: 10 位數補零導致查詢失敗
- **修復**: 改為 7 位數補零
- **檔案**: `src/shared/utils.js`

### 3. 民國年曆年齡計算（2025-11-22）
- **問題**: 無法正確計算民國年格式生日
- **修復**: 支援 7 位數 YYYMMDD 格式
- **檔案**: `src/db/dbf-reader.js`

### 4. 性別顯示（2025-11-22）
- **問題**: 性別代碼未正確對應
- **修復**: 新增 getGenderText() 對應
- **檔案**: `src/renderer/components/PatientHeader.jsx`

### 5. 原生模組編譯（2025-11-22）
- **問題**: NODE_MODULE_VERSION 不符
- **修復**: 執行 npx electron-rebuild
- **解決方案**: 記錄於文件

### 6. DBF 查詢緩慢（2025-11-22）
- **問題**: CO18H 查詢 13-15 秒
- **修復**: 使用 SQLite 快取
- **效果**: 查詢時間降至 < 1 秒

### 7. 預防保健卡序錯誤（2025-11-22）
- **問題**: 成健卡序定義錯誤（22/23 對調）
- **修復**: 更正卡序定義
- **影響**: 所有成人健檢邏輯

### 8. 未過濾完診時間（2025-11-22）
- **問題**: 包含掛號錯誤或未完診記錄
- **修復**: 檢查 TENDTIME 欄位
- **效果**: 提升資料準確性

---

## 未來規劃

### Client-Server 架構（考慮中）

**背景**
- 當前單機版每台電腦占用 150-500MB 記憶體
- 多台電腦總記憶體占用大

**提議方案**
- Server 端：Docker + SQLite + REST API
- Client 端：輕量化，只保留 UI
- 記憶體節省：3 台電腦從 1500MB 降到 650MB（57%）
- 查詢速度：增加 10-20ms（區網延遲），依然很快

**適用情境**
- 3 台以上電腦
- 有穩定區網環境
- 有主機或 NAS 可當 Server

**預估開發時間**
- Server API：4-6 小時
- Client 重構：2-3 小時
- Docker 配置：1 小時
- 總計：1 個工作天

**決策待定** - 目前單機版已可滿足需求，暫不實作

---

## 技術債與已知問題

### 已知資料品質問題
- 部分病患缺少電話號碼、地址
- 部分病患生日無效（年齡顯示 N/A）
- **狀態**: 預期行為，系統會妥善處理

### Smart Action List
- **狀態**: 已停用（使用者要求簡化 UI）
- **重新啟用**: 取消註解 `src/renderer/App.jsx` 中的元件

### 效能預期
- 病患查詢：< 100ms（預載入後）
- 啟動時間：20-30 秒（預載入時間）
- 記憶體占用：150-500MB（依設定）

---

**維護者**: Claude Code
**最後更新**: 2025-11-22
