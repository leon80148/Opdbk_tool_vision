# 安家診所掛號助手 - 使用手冊 v0.9.0

> 詳細操作指引與功能說明

---

## 📚 目錄

- [系統介紹](#系統介紹)
- [首次安裝與設定](#首次安裝與設定)
- [介面說明](#介面說明)
- [基本操作](#基本操作)
- [進階功能](#進階功能)
- [預防保健判斷規則](#預防保健判斷規則)
- [常見使用情境](#常見使用情境)
- [疑難排解](#疑難排解)
- [快捷鍵總覽](#快捷鍵總覽)

---

## 系統介紹

**安家診所掛號助手**是專為診所櫃檯人員設計的智慧化病患資訊管理工具。整合 HIS 系統資料，提供：

- ✅ 快速病患資料查詢（< 0.1 秒）
- ✅ 預防保健服務判斷（成健、篩檢、疫苗）
- ✅ 預約與就診歷史查詢
- ✅ 慢性病管理記錄
- ✅ 檢查記錄追蹤
- ✅ 熱鍵快速操作

### 系統需求

- **作業系統**：Windows 10/11 (64-bit)
- **記憶體**：建議 4GB 以上（應用程式占用約 150-600MB）
- **磁碟空間**：200MB（含資料庫快取）
- **HIS 系統**：需有 DBF 格式資料檔案

---

## 首次安裝與設定

### 步驟 1：安裝應用程式

1. 執行 `安家診所掛號助手-Setup-4.4.0.exe`
2. 選擇安裝目錄（例如：`C:\Program Files\Anchia OPD Toolkit`）
3. 勾選「建立桌面捷徑」
4. 點選「安裝」
5. 完成安裝

### 步驟 2：設定資料來源

安裝完成後，**首次啟動前**需設定 DBF 資料路徑：

1. 開啟安裝目錄（例如：`C:\Program Files\Anchia OPD Toolkit`）
2. 找到 `config.ini` 檔案，使用記事本開啟
3. 修改以下設定：

```ini
[database]
# DBF 資料庫根目錄（請修改為實際路徑）
dbf_root = Z:\\HIS\\DATA\\
# SQLite 快取資料庫路徑（建議放在本機硬碟）
sqlite_path = C:\\Program Files\\Anchia OPD Toolkit\\data\\lab_cache.db
# 預載入資料範圍（年數，建議 3 年）
preload_years_back = 3
```

> **重要提示**：
> - 路徑必須使用雙反斜線 `\\` 或單斜線 `/`
> - `dbf_root` 通常為 HIS 系統的資料目錄（可能是網路磁碟機）
> - `sqlite_path` 建議放在本機硬碟以提升效能

4. 儲存 `config.ini`

### 步驟 3：首次啟動

1. 雙擊桌面捷徑或從開始功能表啟動
2. 首次啟動會顯示「載入進度」畫面
3. 系統會預載入 DBF 資料至記憶體（約 15-20 秒）
4. 預載入完成後，會顯示主介面

> **注意**：首次啟動會較慢（預載入資料），之後啟動速度相同。

---

## 介面說明

### 主介面佈局

```
┌──────────────────────────────────────────────────────────┐
│  🔍 [病歷號搜尋框]  [查詢]  ⚙️設定                        │
├──────────────────────────────────────────────────────────┤
│                                                            │
│  ┌─────────────────────┐  ┌─────────────────────────┐   │
│  │  病患基本資料        │  │  預防保健管理           │   │
│  │  - 姓名、性別、年齡  │  │  - 成人健檢一階 ✓       │   │
│  │  - 身分證、聯絡方式  │  │  - 成人健檢二階         │   │
│  │  - 備註             │  │  - 腸篩 ✓               │   │
│  └─────────────────────┘  │  - 口篩                │   │
│                           │  - 流感疫苗             │   │
│  ┌─────────────────────┐  │  - 新冠疫苗             │   │
│  │  預約紀錄            │  │  - 肺鏈疫苗 ✓           │   │
│  │  - 日期、時段、醫師  │  └─────────────────────────┘   │
│  └─────────────────────┘                                │
│                                                            │
│  ┌──────────────────────────────────────────────────┐   │
│  │  就診歷史（最近 10 次）                            │   │
│  │  日期 | 時間 | 類別 | 診斷 | 開藥天數 | 慢箋 | 到期日│   │
│  └──────────────────────────────────────────────────┘   │
│                                                            │
│  ┌──────────────────────────────────────────────────┐   │
│  │  慢性病管理（糖尿病、腎臟病、代謝症候群）          │   │
│  └──────────────────────────────────────────────────┘   │
│                                                            │
│  ┌──────────────────────────────────────────────────┐   │
│  │  檢查記錄（腹超、甲超、肺功能等）                  │   │
│  └──────────────────────────────────────────────────┘   │
│                                                            │
└──────────────────────────────────────────────────────────┘
```

### 各區域說明

#### 1. 搜尋列

- **病歷號搜尋框**：輸入病歷號（1-7 位數字）
- **查詢按鈕**：點擊或按 Enter 執行查詢
- **設定按鈕**（⚙️）：開啟設定介面

#### 2. 病患基本資料卡片（左上）

顯示內容：
- 姓名、性別、年齡
- 身分證字號
- 電話號碼
- 地址
- 備註（完整顯示，不截斷）
- VIP 標籤（若有）

#### 3. 預防保健管理卡片（右上）

顯示 7 項預防保健服務：
- ✅ **綠色勾勾**：符合執行條件
- **空白**：不符合執行條件
- **最近五年內日期**：顯示最近一次執行日期

#### 4. 預約紀錄卡片

顯示未來 3 個月的預約記錄：
- 預約日期
- 時段（早、午、晚、夜）
- 看診醫師

#### 5. 就診歷史卡片

顯示最近 10 次就診記錄：
- 看診日期與時間
- 就診類別（門診、急診等）
- 主診斷代碼
- 開藥天數
- 慢箋次數
- **慢箋到期日**（自動計算）
- 註記

#### 6. 慢性病管理卡片

分三類顯示最近兩年記錄：
- **糖尿病管理**
- **腎臟病管理**
- **代謝症候群管理**

每筆記錄顯示：
- 執行日期
- 醫令名稱
- 下次可執行日（僅第一筆顯示）

#### 7. 檢查記錄卡片

顯示 3 年內的檢查記錄：
- 腹部超音波
- 甲狀腺超音波
- 細針穿刺
- 肺功能檢查
- 尿流速檢查

每項顯示：
- 檢查日期
- 種類代碼
- 報告內容（過長會截斷，滑鼠移上顯示完整內容）
- 建議下次追蹤日期

---

## 基本操作

### 查詢病患資料

#### 方法一：手動輸入

1. 在搜尋框輸入病歷號（例如：`1`、`27`、`1234`）
2. 按下 `Enter` 鍵或點擊「查詢」按鈕
3. 系統自動補零為 7 位數查詢
4. 查詢結果立即顯示（< 0.1 秒）

**示範**：
```
輸入：1      → 查詢：0000001
輸入：27     → 查詢：0000027
輸入：1234   → 查詢：0001234
輸入：1234567 → 查詢：1234567
```

#### 方法二：熱鍵擷取（推薦）

1. 在 HIS 系統或任何視窗中，選中（反白）病歷號文字
2. 按下擷取熱鍵（預設：`Ctrl+Alt+G`）
3. 系統自動：
   - 將選中的文字複製
   - 切換到掛號助手視窗
   - 自動查詢該病歷號

**優點**：
- 快速：不需手動切換視窗
- 準確：避免輸入錯誤
- 方便：無需離開 HIS 系統

### 查看預防保健資訊

查詢病患後，右上方「預防保健管理」卡片會顯示：

#### 符號說明

- **✅ 綠色勾勾**：符合執行條件，可以申報
- **空白**：不符合執行條件，尚未到執行時間
- **日期顯示**：最近 5 年內的執行日期

#### 判斷邏輯示例

**成人健檢一階**：
- 病患 35 歲：
  - 最近一次：2020/05/10（當時 30 歲用卡序 3D）
  - 今年：2025 年
  - 間隔：5 年 ✅ **可執行**（30-39 歲每 5 年一次）

- 病患 40 歲：
  - 最近一次：2024/03/15（當時 39 歲用卡序 3D）
  - 今年：2025 年
  - 年齡層轉換：39→40 歲 ✅ **可執行**（年齡層變更可重新執行）

**流感疫苗**：
- 病患 55 歲：
  - 最近一次：2024/11/05（2024 施打季）
  - 今年：2025/01/10
  - 同一施打季：2024/10-2025/6 ❌ **不可執行**
- 若為：2025/10/01（2025 施打季）✅ **可執行**

### 查看就診歷史與慢箋到期日

**就診歷史表格**會顯示慢箋到期日：

計算公式：
```
慢箋到期日 = 看診日期 + (開藥天數 × 慢箋次數)
```

**示範**：
- 看診日期：2025/01/05
- 開藥天數：28 天
- 慢箋次數：3 次
- **到期日**：2025/01/05 + (28 × 3) = **2025/03/30**

---

## 進階功能

### 設定熱鍵

#### 步驟 1：開啟設定

1. 點擊主介面右上角的 **⚙️ 設定** 按鈕
2. 進入設定介面

#### 步驟 2：錄製熱鍵

設定介面有兩個熱鍵欄位：
1. **視窗切換熱鍵**：喚出應用程式（從任何視窗切換過來）
2. **病歷號擷取熱鍵**：自動擷取並查詢

**錄製步驟**：
1. 點擊欄位旁的「**開始錄製**」按鈕
2. 按下你想要的組合鍵（例如：`Ctrl+Alt+A`）
3. 系統會顯示錄製到的組合鍵
4. 點擊「**儲存設定**」

#### 步驟 3：測試熱鍵

1. 關閉設定視窗
2. 切換到其他應用程式（例如：HIS 系統）
3. 按下剛設定的熱鍵，測試是否正常

**注意事項**：
- 避免使用已被其他程式佔用的熱鍵組合
- 建議使用 `Ctrl+Alt+` 或 `Ctrl+Shift+` 開頭
- 熱鍵設定即時生效，無需重新啟動

### 調整記憶體使用

若覺得應用程式記憶體占用過高，可調整預載入範圍：

1. 關閉應用程式
2. 開啟 `config.ini` 檔案
3. 找到 `[database]` 區塊：

```ini
[database]
# 預載入資料範圍（年數）
preload_years_back = 3  # 改為 1 或 2 可減少記憶體
```

**效果比較**：
| 設定值 | 記憶體占用 | 查詢速度 | 適用情境 |
|--------|-----------|---------|---------|
| 3 年   | ~596MB    | < 0.1 秒 | 一般使用 |
| 2 年   | ~400MB    | < 0.1 秒 | 記憶體有限 |
| 1 年   | ~200MB    | < 0.1 秒 | 記憶體很小 |

4. 儲存後重新啟動應用程式

### 調整同步設定

若不需要定期同步（例如：DBF 資料很少更新），可關閉定期同步：

```ini
[sync]
# 同步間隔（分鐘），0 = 僅啟動時同步
interval_minutes = 0  # 改為 0 停用定期同步
```

---

## 預防保健判斷規則

### 成人健檢一階

**年齡條件與間隔**：
- **30-39 歲**：每 5 年一次（卡序：`3D`）
- **40-64 歲**：每 3 年一次（卡序：`21`）
- **65 歲以上**：每年一次（卡序：`22`）

**年齡轉換處理**：
- 當病患從一個年齡層進入下一個年齡層，可重新執行
- 例如：39 歲用 `3D` 執行過，40 歲可用 `21` 再次執行

**判斷邏輯**：
```
1. 找出最近一次一階記錄（不限卡序 3D、21、22）
2. 取得當時的年齡層和當前年齡層
3. 若年齡層不同 → 可執行
4. 若年齡層相同 → 檢查間隔年數：
   - 30-39 歲：需間隔 ≥ 5 年
   - 40-64 歲：需間隔 ≥ 3 年
   - 65 歲以上：需間隔 ≥ 1 年
```

### 成人健檢二階

**執行條件**：
- 當年度已執行成健一階（任一卡序 3D、21、22）
- 當年度尚未執行成健二階（任一卡序 3E、23、24）

**判斷邏輯**：
```
1. 查找今年是否有執行一階記錄
2. 若無 → 不可執行（需先執行一階）
3. 若有 → 查找今年是否已執行二階
4. 若已執行二階 → 不可執行
5. 若未執行二階 → 可執行
```

### 腸篩（大腸癌篩檢）

**條件**：
- **年齡**：45-74 歲
- **間隔**：兩年一次（卡序：`85`）

**判斷**：
```
今年 - 最近一次執行年份 >= 2 → 可執行
```

### 口篩（口腔癌篩檢）

**條件**：
- **年齡**：30 歲以上
- **間隔**：兩年一次（卡序：`95`）

**判斷**：
```
今年 - 最近一次執行年份 >= 2 → 可執行
```

### 流感疫苗

**條件**：
- **年齡**：50 歲以上（可在 config.ini 調整）
- **間隔**：按「施打季」計算（卡序：`AU`）

**施打季定義**：
```
每年 10 月 - 隔年 6 月 = 同一個施打季

例如：
- 2024/10/01 - 2025/06/30 = 2024 施打季
- 2025/10/01 - 2026/06/30 = 2025 施打季
```

**判斷邏輯**：
```
1. 計算當前日期的施打季
2. 計算最近一次施打日期的施打季
3. 若不在同一施打季 → 可執行
```

**示範**：
- 最近一次：2024/11/05（2024 施打季）
- 當前日期：2025/01/15（仍在 2024 施打季） → **不可執行**
- 當前日期：2025/10/01（2025 施打季） → **可執行**

### 新冠疫苗

**條件與判斷**：
- 與流感疫苗完全相同
- 年齡：50 歲以上
- 按施打季計算（卡序：`VU`）

### 肺鏈疫苗

**條件**：
- **年齡**：65 歲以上
- **間隔**：終身一劑（卡序：`DU`）

**判斷**：
```
若有任何執行記錄 → 不可執行
若無執行記錄 → 可執行
```

---

## 常見使用情境

### 情境 1：櫃檯掛號時快速查詢

**步驟**：
1. 病患報到，提供病歷號
2. 在 HIS 系統開啟病患資料
3. 反白病歷號，按下擷取熱鍵（`Ctrl+Alt+G`）
4. 掛號助手自動顯示病患資料
5. 查看預防保健卡片，若有 ✅ 詢問病患是否需要

### 情境 2：判斷成人健檢執行條件

**問題**：病患問「我可以做成人健檢嗎？」

**步驟**：
1. 查詢病患資料
2. 查看「預防保健管理」卡片的「成人健檢一階」
3. 若有 ✅：可以執行
4. 若無 ✅：查看「最近五年內」日期，告知下次可執行時間

**進階判斷**：
- 若一階有 ✅，查看「成人健檢二階」
- 若二階也有 ✅，表示當年度已做一階但未做二階
- 可詢問病患是否需要加做二階

### 情境 3：慢箋到期提醒

**問題**：病患來拿慢箋，需確認是否已到期

**步驟**：
1. 查詢病患資料
2. 查看「就診歷史」表格
3. 找到最近一次開立慢箋的記錄
4. 查看「慢箋到期日」欄位
5. 對照今天日期：
   - 若已過期 → 可以領藥
   - 若未到期 → 告知還需等幾天

### 情境 4：預防保健衛教

**問題**：病患符合多項預防保健，需衛教說明

**步驟**：
1. 查詢病患資料
2. 查看所有有 ✅ 的項目
3. 依序說明：
   - 「您可以做成人健檢一階，是全額補助的」
   - 「您也可以做大腸癌篩檢（腸篩），兩年一次」
   - 「流感疫苗也到了施打時間，需要嗎？」

---

## 疑難排解

### 問題 1：查詢病患顯示「查無此病患」

**可能原因**：
1. 病歷號輸入錯誤
2. HIS 系統中無此病患
3. 資料尚未同步至記憶體

**解決方法**：
1. 確認病歷號是否正確（純數字，不含空格）
2. 到 HIS 系統確認該病歷號是否存在
3. 重新啟動應用程式，等待資料預載入完成

### 問題 2：熱鍵按下後沒有反應

**可能原因**：
1. 熱鍵與其他程式衝突
2. 應用程式未正常啟動
3. 熱鍵設定錯誤

**解決方法**：
1. 開啟設定，重新錄製熱鍵（換一組組合鍵）
2. 確認應用程式在背景執行（檢查工作列）
3. 重新啟動應用程式

### 問題 3：預防保健判斷不準確

**可能原因**：
1. HIS 資料中有未完診的掛號記錄
2. 生日資料錯誤導致年齡計算錯誤

**解決方法**：
1. 應用程式已自動過濾未完診記錄（TENDTIME 檢查）
2. 到 HIS 系統確認病患生日是否正確
3. 若資料有誤，修正後重新啟動應用程式

### 問題 4：慢箋到期日計算錯誤

**可能原因**：
1. HIS 系統的開藥天數或慢箋次數資料錯誤
2. 日期格式問題

**解決方法**：
1. 確認 HIS 系統中的「開藥天數」和「慢箋次數」正確
2. 計算公式：開立日期 + (開藥天數 × 慢箋次數)
3. 手動驗證計算結果

### 問題 5：應用程式啟動速度很慢

**可能原因**：
1. 預載入資料量大（3 年資料）
2. DBF 檔案位於網路磁碟

**解決方法**：
1. 調整 `config.ini` 中的 `preload_years_back = 1`（減少為 1 年）
2. 啟動速度約可減半（15 秒 → 7 秒）
3. 權衡：舊資料查詢會變慢

### 問題 6：介面顯示中文亂碼

**可能原因**：
1. DBF 檔案編碼不是 Big5
2. 系統區域設定問題

**解決方法**：
1. 確認 HIS 系統使用 Big5 編碼
2. 檢查 Windows 區域設定是否為「繁體中文（台灣）」
3. 重新安裝應用程式

### 問題 7：記憶體占用過高

**解決方法**：
1. 開啟 `config.ini`
2. 調整 `preload_years_back = 1`（改為 1 年）
3. 記憶體占用：596MB → 200MB
4. 重新啟動應用程式

---

## 快捷鍵總覽

| 快捷鍵 | 功能 | 說明 | 可自訂 |
|--------|------|------|--------|
| **Ctrl+Alt+C** | 視窗切換 | 從任何視窗喚出掛號助手 | ✅ |
| **Ctrl+Alt+G** | 病歷號擷取 | 自動擷取選中的病歷號並查詢 | ✅ |
| **Enter** | 執行查詢 | 在搜尋框按 Enter 執行查詢 | ❌ |
| **Esc** | 關閉設定 | 關閉設定視窗 | ❌ |

### 自訂熱鍵建議

**視窗切換熱鍵**（常用）：
- `Ctrl+Alt+A`（A = Anchia）
- `Ctrl+Alt+C`（C = Clinic，預設）
- `Ctrl+Shift+A`

**病歷號擷取熱鍵**（常用）：
- `Ctrl+Alt+G`（G = Get，預設）
- `Ctrl+Alt+Q`（Q = Query）
- `Ctrl+Shift+G`

**避免使用的組合鍵**：
- `Ctrl+C`、`Ctrl+V`（系統預設的複製貼上）
- `Ctrl+Alt+Delete`（系統功能）
- `Alt+F4`（關閉視窗）
- `Win+D`（顯示桌面）

---

## 附錄：設定檔完整說明

### config.ini 完整範例

```ini
[database]
# DBF 資料庫根目錄
dbf_root = Z:\\HIS\\DATA\\
# SQLite 快取資料庫路徑
sqlite_path = C:\\Program Files\\Anchia OPD Toolkit\\data\\lab_cache.db
# 預載入資料範圍（年）
preload_years_back = 3
# 檔案編碼
encoding = big5

[hotkey]
# 視窗切換熱鍵
global = Ctrl+Alt+C
# 病歷號擷取熱鍵
capture = Ctrl+Alt+G
# 熱鍵衝突處理（warn/skip/override）
conflict_handling = warn

[sync]
# 同步間隔（分鐘），0 = 僅啟動時同步
interval_minutes = 10
# 啟動時同步
sync_on_startup = true
# 批次大小
batch_size = 5000

[labs]
# 檢驗項目代碼對應表路徑
lab_code_map = C:\\Program Files\\Anchia OPD Toolkit\\config\\lab_codes.json
# 資料保留年數
data_retention_years = 3

[ui]
# 隱藏選單列
hide_menu_bar = true
# 啟動時最大化
start_maximized = true

[preventive_care]
# 流感疫苗年齡限制
flu_vaccine_min_age = 50
# 新冠疫苗年齡限制
covid_vaccine_min_age = 50
```

---

## 聯絡支援

如有其他問題或建議，請聯絡開發團隊。

---

**安家診所掛號助手 v0.9.0 使用手冊** - 最後更新：2025-11-23
